<!DOCTYPE html>
<html>

<head>
	<title>주변 탈모 병원 찾기</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- 부트스트랩 CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- 카카오맵 API - autoload=false 추가하고 콜백 방식으로 변경 -->
	<script type="text/javascript"
		src="//dapi.kakao.com/v2/maps/sdk.js?appkey=2b962d0ab211df404dd13c6c6f179415&libraries=services&autoload=false"></script>
	<style>
		#map {
			width: 100%;
			height: 500px;
			border-radius: 10px;
			margin-bottom: 20px;
		}

		.hospital-item {
			padding: 15px;
			border-bottom: 1px solid #eee;
			cursor: pointer;
		}

		.hospital-item:hover {
			background-color: #f8f9fa;
		}

		.hospital-name {
			font-weight: bold;
			margin-bottom: 5px;
		}

		.hospital-address,
		.hospital-phone {
			color: #666;
			font-size: 0.9rem;
			margin-bottom: 3px;
		}

		.loading {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(255, 255, 255, 0.8);
			display: flex;
			justify-content: center;
			align-items: center;
			z-index: 1000;
		}

		.category-buttons {
			margin-bottom: 15px;
		}

		.category-buttons button {
			margin-right: 5px;
			margin-bottom: 5px;
		}

		.error-message {
			color: #dc3545;
			font-size: 0.9rem;
			margin-top: 10px;
		}

		.info-message {
			color: #0d6efd;
			font-size: 0.9rem;
			margin-top: 10px;
		}
	</style>
</head>

<body>
	<div class="container mt-4">
		<h1 class="mb-4">주변 탈모 병원 찾기</h1>

		<div class="card mb-4">
			<div class="card-body">
				<div class="row">
					<div class="col-md-6">
						<div class="input-group mb-3">
							<input type="text" id="keyword" class="form-control" placeholder="검색어 입력 (예: 강남 탈모 병원)">
							<button class="btn btn-primary" type="button" onclick="searchByKeyword()">검색</button>
						</div>
					</div>
					<div class="col-md-6">
						<div class="d-flex justify-content-end">
							<button class="btn btn-success me-2" onclick="getCurrentLocation()">내 위치에서 검색</button>
							<select id="radius" class="form-select" style="width: auto;">
								<option value="1000">1km 이내</option>
								<option value="2000" selected>2km 이내</option>
								<option value="5000">5km 이내</option>
								<option value="10000">10km 이내</option>
							</select>
						</div>
					</div>
				</div>

				<div class="category-buttons">
					<button class="btn btn-outline-secondary" onclick="searchByCategory('탈모 병원')">탈모 병원</button>
					<button class="btn btn-outline-secondary" onclick="searchByCategory('탈모 치료')">탈모 치료</button>
					<button class="btn btn-outline-secondary" onclick="searchByCategory('모발 이식')">모발 이식</button>
					<button class="btn btn-outline-secondary" onclick="searchByCategory('두피 클리닉')">두피 클리닉</button>
					<button class="btn btn-outline-secondary" onclick="searchByCategory('피부과')">피부과</button>
				</div>

				<!-- 메시지 표시 영역 추가 -->
				<div id="messageArea"></div>
			</div>
		</div>

		<div class="row">
			<div class="col-md-8">
				<div id="map"></div>
			</div>
			<div class="col-md-4">
				<div class="card">
					<div class="card-header">
						<h5 class="mb-0">검색 결과</h5>
					</div>
					<div class="card-body p-0" style="max-height: 500px; overflow-y: auto;">
						<div id="hospital-list">
							<div class="text-center p-4">
								<p class="text-muted">위치 정보를 불러오는 중입니다...</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- 로딩 인디케이터 -->
	<div id="loading" class="loading">
		<div class="spinner-border text-primary" role="status">
			<span class="visually-hidden">Loading...</span>
		</div>
	</div>

	<script>
			var map;
			var markers = [];
			var infowindows = [];
			var currentPosition;
			var isFirstSearch = true;
			var searchTimeout; // 타임아웃 추가

			// DOM 요소가 로드된 후 실행
			document.addEventListener('DOMContentLoaded', function () {
				console.log("DOM 로드 완료");
				// 안전장치 - 30초 후에 강제로 로딩 숨기기
				setTimeout(function () {
					if (document.getElementById('loading').style.display !== 'none') {
						console.log("안전장치 작동: 로딩 시간 초과");
						showLoading(false);
						showMessage("로딩 시간이 초과되었습니다. 페이지를 새로고침하거나 다시 시도해 주세요.", "error");
					}
				}, 30000);

				// 카카오맵 API 로드
				kakao.maps.load(function () {
					console.log("카카오맵 API 로드 완료");
					initMap();
					// 초기화 후 약간의 지연을 두고 위치 검색 시작
					setTimeout(function () {
						try {
							getCurrentLocation();
						} catch (e) {
							console.error("위치 검색 오류:", e);
							showLoading(false);
							showMessage("위치 검색 중 오류가 발생했습니다. 페이지를 새로고침해 주세요.", "error");
						}
					}, 1000);
				});
			});

			// 지도 초기화
			function initMap() {
				try {
					var container = document.getElementById('map');
					var options = {
						center: new kakao.maps.LatLng(37.566826, 126.9786567), // 서울 시청
						level: 5
					};
					map = new kakao.maps.Map(container, options);
					console.log("지도 초기화 완료");
				} catch (e) {
					console.error("지도 초기화 오류:", e);
					showMessage("지도를 불러오는 중 오류가 발생했습니다. 페이지를 새로고침해 주세요.", "error");
					showLoading(false);
				}
			}

			// 현재 위치 가져오기
			function getCurrentLocation() {
				showLoading(true);
				try {
					clearMessages();
				} catch (e) {
					console.error("메시지 초기화 오류:", e);
				}

				// 위치 가져오기 타임아웃 설정 (15초)
				var locationTimeout = setTimeout(function() {
					console.log("위치 정보 가져오기 타임아웃");
					showMessage("위치 정보를 가져오는데 시간이 오래 걸립니다. 기본 위치(서울시청)에서 검색합니다.", "error");
					// 기본 위치에서 검색
					fallbackToDefaultLocation();
				}, 15000);

				if (navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(
						function (position) {
							clearTimeout(locationTimeout); // 타임아웃 제거
							console.log("현재 위치 가져오기 성공");
							var lat = position.coords.latitude;
							var lng = position.coords.longitude;
							currentPosition = new kakao.maps.LatLng(lat, lng);

							// 지도 중심 이동
							map.setCenter(currentPosition);

							// 현재 위치 마커 표시
							var marker = new kakao.maps.Marker({
								map: map,
								position: currentPosition,
								image: new kakao.maps.MarkerImage(
									'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
									new kakao.maps.Size(24, 35)
								)
							});

							// 주변 병원 검색 (키워드 배열로 여러번 시도)
							searchMultipleKeywords(['탈모 병원', '두피 클리닉', '피부과', '모발이식']);
						},
						function (error) {
							clearTimeout(locationTimeout); // 타임아웃 제거
							console.error("위치 가져오기 오류:", error);
							showMessage("위치 정보를 가져오는데 실패했습니다. 기본 위치(서울시청)에서 검색합니다.", "error");
							// 기본 위치에서 검색
							fallbackToDefaultLocation();
						},
						{
							enableHighAccuracy: true,
							timeout: 10000,
							maximumAge: 0
						}
					);
				} else {
					showMessage("이 브라우저에서는 위치 정보를 지원하지 않습니다. 기본 위치(서울시청)에서 검색합니다.", "error");
					// 기본 위치에서 검색
					fallbackToDefaultLocation();
				}
			}

			// 기본 위치(서울시청)에서 검색
			function fallbackToDefaultLocation() {
				currentPosition = new kakao.maps.LatLng(37.566826, 126.9786567);
				map.setCenter(currentPosition);
				
				// 현재 위치 마커 표시
				var marker = new kakao.maps.Marker({
					map: map,
					position: currentPosition,
					image: new kakao.maps.MarkerImage(
						'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
						new kakao.maps.Size(24, 35)
					)
				});
				
				searchMultipleKeywords(['탈모 병원', '두피 클리닉', '피부과', '모발이식']);
			}

			// 여러 키워드로 순차적으로 검색 시도
			function searchMultipleKeywords(keywords, index = 0) {
				// 이전 타임아웃 제거
				if (searchTimeout) {
					clearTimeout(searchTimeout);
				}

				// 새 타임아웃 설정 (10초)
				searchTimeout = setTimeout(function() {
					console.log("검색 타임아웃 발생");
					showMessage("검색 시간이 초과되었습니다. 다시 시도해 주세요.", "error");
					showLoading(false);
				}, 10000);

				if (index >= keywords.length) {
					// 모든 키워드로 검색했지만 결과가 없음
					clearTimeout(searchTimeout);
					if (markers.length === 0) {
						showMessage("주변에 탈모 관련 병원을 찾을 수 없습니다. 검색 반경을 넓히거나 다른 키워드로 검색해보세요.", "error");
						document.getElementById('hospital-list').innerHTML = '<div class="text-center p-4"><p class="text-muted">검색 결과가 없습니다.</p></div>';
					}
					showLoading(false);
					return;
				}

				var position = currentPosition || map.getCenter();
				var radius = document.getElementById('radius').value;

				console.log("검색 키워드:", keywords[index]);

				var places = new kakao.maps.services.Places();
				places.keywordSearch(keywords[index], function (result, status) {
					console.log("검색 결과 상태:", status, "결과 수:", result ? result.length : 0);
					
					if (status === kakao.maps.services.Status.OK && result && result.length > 0) {
						// 거리에 따라 결과 필터링
						var filteredResults = result.filter(function (place) {
							var placePosition = new kakao.maps.LatLng(place.y, place.x);
							var distance = getDistance(position, placePosition);
							return distance <= radius;
						});

						console.log("필터링된 결과 수:", filteredResults.length);

						if (filteredResults.length > 0) {
							// 타임아웃 제거
							clearTimeout(searchTimeout);
							// 결과가 있으면 표시
							displaySearchResults(filteredResults);
							if (isFirstSearch) {
								showMessage(filteredResults.length + "개의 " + keywords[index] + " 검색 결과를 찾았습니다.", "info");
								isFirstSearch = false;
							}
							showLoading(false);
						} else {
							// 결과가 없으면 다음 키워드로 검색
							searchMultipleKeywords(keywords, index + 1);
						}
					} else {
						// 검색 실패하면 다음 키워드로 검색
						console.log("키워드 검색 실패 또는 결과 없음, 다음 키워드로 넘어감");
						searchMultipleKeywords(keywords, index + 1);
					}
				}, {
					location: position,
					radius: radius,
					sort: kakao.maps.services.SortBy.DISTANCE
				});
			}

			// 키워드로 검색
			function searchByKeyword() {
				var keyword = document.getElementById('keyword').value;
				if (!keyword.trim()) {
					showMessage("검색어를 입력해주세요.", "error");
					return;
				}

				showLoading(true);
				try {
					clearMessages();
				} catch (e) {
					console.error("메시지 초기화 오류:", e);
				}
				removeAllMarkers();

				// 검색 타임아웃 설정 (10초)
				if (searchTimeout) {
					clearTimeout(searchTimeout);
				}
				searchTimeout = setTimeout(function() {
					console.log("검색 타임아웃 발생");
					showMessage("검색 시간이 초과되었습니다. 다시 시도해 주세요.", "error");
					showLoading(false);
				}, 10000);

				var places = new kakao.maps.services.Places();
				places.keywordSearch(keyword, function (result, status) {
					clearTimeout(searchTimeout);
					
					if (status === kakao.maps.services.Status.OK && result.length > 0) {
						displaySearchResults(result);
						showMessage(result.length + "개의 검색 결과를 찾았습니다.", "info");
					} else {
						showMessage("검색 결과가 없습니다. 다른 키워드로 검색해보세요.", "error");
						document.getElementById('hospital-list').innerHTML = '<div class="text-center p-4"><p class="text-muted">검색 결과가 없습니다.</p></div>';
					}
					showLoading(false);
				});
			}

			// 카테고리로 검색
			function searchByCategory(category) {
				showLoading(true);
				try {
					clearMessages();
				} catch (e) {
					console.error("메시지 초기화 오류:", e);
				}

				var position = currentPosition || map.getCenter();
				var radius = document.getElementById('radius').value;

				removeAllMarkers();

				// 검색 타임아웃 설정 (10초)
				if (searchTimeout) {
					clearTimeout(searchTimeout);
				}
				searchTimeout = setTimeout(function() {
					console.log("카테고리 검색 타임아웃 발생");
					showMessage("검색 시간이 초과되었습니다. 다시 시도해 주세요.", "error");
					showLoading(false);
				}, 10000);

				var places = new kakao.maps.services.Places();
				places.keywordSearch(category, function (result, status) {
					clearTimeout(searchTimeout);
					
					if (status === kakao.maps.services.Status.OK && result.length > 0) {
						// 위치 기반 필터링
						var filteredResults = result.filter(function (place) {
							var placePosition = new kakao.maps.LatLng(place.y, place.x);
							var distance = getDistance(position, placePosition);
							return distance <= radius;
						});

						if (filteredResults.length > 0) {
							displaySearchResults(filteredResults);
							showMessage(filteredResults.length + "개의 " + category + " 검색 결과를 찾았습니다.", "info");
						} else {
							showMessage("주변에 " + category + "을(를) 찾을 수 없습니다. 검색 반경을 넓혀보세요.", "error");
							document.getElementById('hospital-list').innerHTML = '<div class="text-center p-4"><p class="text-muted">검색 결과가 없습니다.</p></div>';
						}
					} else {
						showMessage("검색 결과가 없습니다. 다른 키워드로 검색해보세요.", "error");
						document.getElementById('hospital-list').innerHTML = '<div class="text-center p-4"><p class="text-muted">검색 결과가 없습니다.</p></div>';
					}
					showLoading(false);
				}, {
					location: position,
					radius: radius,
					sort: kakao.maps.services.SortBy.DISTANCE
				});
			}

			// 검색 결과 표시
			function displaySearchResults(places) {
				try {
					var bounds = new kakao.maps.LatLngBounds();
					var hospitalList = document.getElementById('hospital-list');
					hospitalList.innerHTML = '';

					console.log("표시할 장소 수:", places.length);

					for (var i = 0; i < places.length; i++) {
						var place = places[i];
						try {
							displayMarker(place);

							var placePosition = new kakao.maps.LatLng(place.y, place.x);
							bounds.extend(placePosition);

							// 병원 목록 아이템 생성
							var item = document.createElement('div');
							item.className = 'hospital-item';
							item.innerHTML = '<div class="hospital-name">' + place.place_name + '</div>' +
								'<div class="hospital-address">' + place.address_name + '</div>' +
								'<div class="hospital-phone">' + (place.phone || '전화번호 없음') + '</div>';

							// 목록 항목 클릭 시 해당 마커로 이동
							(function (position, index) {
								item.onclick = function () {
									map.setCenter(position);
									map.setLevel(3);

									// 인포윈도우 열기
									closeAllInfowindows();
									if (infowindows[index]) {
										infowindows[index].open(map, markers[index]);
									}
								};
							})(placePosition, i);

							hospitalList.appendChild(item);
						} catch (e) {
							console.error("장소 표시 오류:", e, "장소:", place);
						}
					}

					// 검색된 장소 위치를 기준으로 지도 범위 재설정
					if (places.length > 0) {
						map.setBounds(bounds);
					}
				} catch (e) {
					console.error("검색 결과 표시 오류:", e);
					showMessage("검색 결과를 표시하는 중 오류가 발생했습니다.", "error");
				}
			}

			// 마커 표시
			function displayMarker(place) {
				try {
					var marker = new kakao.maps.Marker({
						map: map,
						position: new kakao.maps.LatLng(place.y, place.x)
					});

					markers.push(marker);

					var infoContent = '<div style="padding:10px;min-width:200px;">' +
						'<h5 style="margin-top:5px;margin-bottom:5px;">' + place.place_name + '</h5>' +
						'<div style="font-size:13px;color:#666;margin-bottom:5px;">' + place.address_name + '</div>';

					if (place.phone) {
						infoContent += '<div style="font-size:13px;color:#666;margin-bottom:5px;">☎ ' + place.phone + '</div>';
					}

					if (place.place_url) {
						infoContent += '<a href="' + place.place_url + '" target="_blank" style="color:#007bff;font-size:13px;">상세 정보 보기</a>';
					}

					infoContent += '</div>';

					var infowindow = new kakao.maps.InfoWindow({
						content: infoContent
					});

					infowindows.push(infowindow);

					kakao.maps.event.addListener(marker, 'click', function () {
						closeAllInfowindows();
						infowindow.open(map, marker);
					});
				} catch (e) {
					console.error("마커 표시 오류:", e, "장소:", place);
				}
			}

			// 모든 마커 제거
			function removeAllMarkers() {
				for (var i = 0; i < markers.length; i++) {
					markers[i].setMap(null);
				}
				markers = [];

				closeAllInfowindows();
			}

			// 모든 인포윈도우 닫기
			function closeAllInfowindows() {
				for (var i = 0; i < infowindows.length; i++) {
					if (infowindows[i]) {
						infowindows[i].close();
					}
				}
			}

			// 두 지점 간의 거리 계산 (미터 단위)
			function getDistance(latlng1, latlng2) {
				try {
					var lat1 = latlng1.getLat();
					var lng1 = latlng1.getLng();
					var lat2 = latlng2.getLat();
					var lng2 = latlng2.getLng();

					function deg2rad(deg) {
						return deg * (Math.PI / 180);
					}

					var R = 6371; // 지구 반경 (km)
					var dLat = deg2rad(lat2 - lat1);
					var dLng = deg2rad(lng2 - lng1);
					var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
						Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
						Math.sin(dLng / 2) * Math.sin(dLng / 2);
					var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
					var distance = R * c * 1000; // 미터 단위로 변환

					return distance;
				} catch (e) {
					console.error("거리 계산 오류:", e);
					return Infinity; // 오류 발생 시 무한대 거리 반환 (필터링에서 제외되도록)
				}
			}

			// 메시지 표시
			function showMessage(message, type) {
				try {
					var messageArea = document.getElementById('messageArea');
					if (messageArea) {
						var className = type === 'error' ? 'error-message' : 'info-message';
						messageArea.innerHTML = '<div class="' + className + '">' + message + '</div>';
					} else {
						console.error("메시지 영역을 찾을 수 없습니다.");
					}
				} catch (e) {
					console.error("메시지 표시 오류:", e);
				}
			}

			// 메시지 초기화
			function clearMessages() {
				try {
					var messageArea = document.getElementById('messageArea');
					if (messageArea) {
						messageArea.innerHTML = '';
					} else {
						console.error("메시지 영역을 찾을 수 없습니다.");
					}
				} catch (e) {
					console.error("메시지 초기화 오류:", e);
				}
			}

			// 로딩 표시
			function showLoading(show) {
				try {
					var loadingElement = document.getElementById('loading');
					if (loadingElement) {
						loadingElement.style.display = show ? 'flex' : 'none';
					} else {
						console.error("로딩 영역을 찾을 수 없습니다.");
					}
				} catch (e) {
					console.error("로딩 표시 오류:", e);
				}
			}
		</script>

		<!-- 부트스트랩 JS -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	</body>


</html>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teachable Machine 탈모 분류기</title>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
            text-align: center;
        }
        .upload-area {
            border: 2px dashed #ccc;
            padding: 40px 20px;
            text-align: center;
            margin: 20px 0;
            border-radius: 5px;
            cursor: pointer;
        }
        .button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        .button:disabled {
            background-color: #cccccc;
        }
        input[type="file"] {
            display: none;
        }
        .progress {
            width: 100%;
            height: 20px;
            background-color: #f1f1f1;
            border-radius: 5px;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background-color: #4CAF50;
            border-radius: 5px;
            width: 0%;
        }
        .results {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        .category {
            flex: 1;
            min-width: 300px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        .category h3 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .category-images {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .image-item {
            position: relative;
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
        }
        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 5px;
        }
        .image-confidence {
            position: absolute;
            bottom: -15px;
            left: 0;
            right: 0;
            font-size: 10px;
            text-align: center;
        }
        .status {
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }
        #modelUrl {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Teachable Machine 탈모 분류기</h1>
        
        <div>
            <p>Teachable Machine에서 생성된 모델 URL을 입력하세요:</p>
            <input type="text" id="modelUrl" placeholder="https://teachablemachine.withgoogle.com/models/YOUR_MODEL_ID/">
            <button class="button" id="loadModelBtn">모델 로드</button>
            <div id="modelStatus" class="status"></div>
        </div>
        
        <div class="upload-area" id="uploadArea">
            <p>이미지를 여기에 드래그하거나 클릭하여 업로드하세요</p>
            <p>여러 이미지를 한 번에 선택할 수 있습니다</p>
        </div>
        <input type="file" id="imageInput" multiple accept="image/*">
        
        <div id="uploadStatus" class="status"></div>
        <div class="progress">
            <div id="progressBar" class="progress-bar"></div>
        </div>
        <button id="classifyBtn" class="button" disabled>이미지 분류 시작</button>
        
        <div id="resultsArea" class="results">
            <!-- 결과가 여기에 표시됩니다 -->
        </div>
        
        <div id="saveBtnArea" style="display: none; margin-top: 20px; text-align: center;">
            <button id="saveResultBtn" class="button">결과를 CSV 파일로 저장</button>
        </div>
    </div>

    <!-- TensorFlow.js와 Teachable Machine 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    
    <script>
        // 전역 변수
        let model;
        let labelContainer;
        let labels = [];
        let selectedImages = [];
        let classifiedImages = {};
        
        // DOM 요소
        const modelUrl = document.getElementById('modelUrl');
        const loadModelBtn = document.getElementById('loadModelBtn');
        const modelStatus = document.getElementById('modelStatus');
        const uploadArea = document.getElementById('uploadArea');
        const imageInput = document.getElementById('imageInput');
        const uploadStatus = document.getElementById('uploadStatus');
        const progressBar = document.getElementById('progressBar');
        const classifyBtn = document.getElementById('classifyBtn');
        const resultsArea = document.getElementById('resultsArea');
        const saveBtnArea = document.getElementById('saveBtnArea');
        const saveResultBtn = document.getElementById('saveResultBtn');
        
        // 모델 로드
        loadModelBtn.addEventListener('click', async function() {
            const url = modelUrl.value.trim();
            if (!url) {
                modelStatus.textContent = "URL을 입력해주세요.";
                return;
            }
            
            modelStatus.textContent = "모델 로딩 중...";
            loadModelBtn.disabled = true;
            
            try {
                // 모델 URL에서 모델 ID 추출
                const modelId = url.split('/').filter(Boolean).pop();
                const modelURL = `https://teachablemachine.withgoogle.com/models/${modelId}/`;
                
                // Teachable Machine 모델 로드
                model = await tmImage.load(
                    `${modelURL}model.json`,
                    `${modelURL}metadata.json`
                );
                
                // 모델 클래스 정보 가져오기
                labels = model.getClassLabels();
                
                modelStatus.textContent = `모델 로드 완료! ${labels.length}개의 클래스 감지됨: ${labels.join(', ')}`;
                classifyBtn.disabled = true;
                
                // 결과 영역 초기화
                initializeResultsArea();
                
            } catch (error) {
                modelStatus.textContent = `모델 로드 실패: ${error.message}`;
                loadModelBtn.disabled = false;
            }
        });
        
        // 이미지 업로드 영역 설정
        uploadArea.addEventListener('click', () => {
            imageInput.click();
        });
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#4CAF50';
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#ccc';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ccc';
            handleImageFiles(e.dataTransfer.files);
        });
        
        // 이미지 선택 처리
        imageInput.addEventListener('change', (e) => {
            handleImageFiles(e.target.files);
        });
        
        // 이미지 파일 처리
        function handleImageFiles(files) {
            if (!model) {
                uploadStatus.textContent = "먼저 모델을 로드해주세요.";
                return;
            }
            
            selectedImages = Array.from(files).filter(file => file.type.startsWith('image/'));
            
            if (selectedImages.length === 0) {
                uploadStatus.textContent = "선택된 이미지가 없습니다.";
                classifyBtn.disabled = true;
                return;
            }
            
            uploadStatus.textContent = `${selectedImages.length}개의 이미지가 선택되었습니다. '이미지 분류 시작' 버튼을 클릭하세요.`;
            classifyBtn.disabled = false;
        }
        
        // 결과 영역 초기화
        function initializeResultsArea() {
            resultsArea.innerHTML = '';
            
            // 각 클래스별 결과 영역 생성
            for (const label of labels) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                categoryDiv.innerHTML = `
                    <h3>${label}</h3>
                    <div class="category-stats" id="stats-${label}">0개 이미지</div>
                    <div id="category-${label}" class="category-images"></div>
                `;
                resultsArea.appendChild(categoryDiv);
                
                // 결과 객체 초기화
                classifiedImages[label] = [];
            }
            
            // 불확실한 이미지를 위한 카테고리 추가
            const uncertainDiv = document.createElement('div');
            uncertainDiv.className = 'category';
            uncertainDiv.innerHTML = `
                <h3>불확실</h3>
                <div class="category-stats" id="stats-uncertain">0개 이미지</div>
                <div id="category-uncertain" class="category-images"></div>
            `;
            resultsArea.appendChild(uncertainDiv);
            classifiedImages['uncertain'] = [];
        }
        
        // 이미지 분류 시작
        classifyBtn.addEventListener('click', async function() {
            if (!model || selectedImages.length === 0) return;
            
            classifyBtn.disabled = true;
            uploadStatus.textContent = "이미지 분류 중...";
            progressBar.style.width = '0%';
            
            // 결과 초기화
            for (const label of [...labels, 'uncertain']) {
                classifiedImages[label] = [];
                document.getElementById(`category-${label}`).innerHTML = '';
                document.getElementById(`stats-${label}`).textContent = '0개 이미지';
            }
            
            // 각 이미지 분류
            const threshold = 0.7; // 신뢰도 임계값
            let processedCount = 0;
            
            for (const imageFile of selectedImages) {
                try {
                    // 이미지 로드
                    const img = await createImageBitmap(imageFile);
                    
                    // 이미지를 Canvas에 그리기
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    // 예측
                    const predictions = await model.predict(canvas);
                    
                    // 최고 확률 클래스 찾기
                    let maxProbIndex = 0;
                    let maxProb = 0;
                    
                    for (let i = 0; i < predictions.length; i++) {
                        if (predictions[i].probability > maxProb) {
                            maxProb = predictions[i].probability;
                            maxProbIndex = i;
                        }
                    }
                    
                    // 예측 결과 저장
                    const predictedClass = maxProb >= threshold ? predictions[maxProbIndex].className : 'uncertain';
                    classifiedImages[predictedClass].push({
                        file: imageFile,
                        confidence: maxProb,
                        predictions: predictions
                    });
                    
                    // 결과 표시
                    const imgElement = document.createElement('div');
                    imgElement.className = 'image-item';
                    
                    // 이미지 URL 생성
                    const imageUrl = URL.createObjectURL(imageFile);
                    
                    imgElement.innerHTML = `
                        <img src="${imageUrl}" title="${imageFile.name}">
                        <div class="image-confidence">${(maxProb * 100).toFixed(0)}%</div>
                    `;
                    
                    document.getElementById(`category-${predictedClass}`).appendChild(imgElement);
                    
                    // 통계 업데이트
                    document.getElementById(`stats-${predictedClass}`).textContent = 
                        `${classifiedImages[predictedClass].length}개 이미지`;
                    
                    // 진행 상태 업데이트
                    processedCount++;
                    const progress = (processedCount / selectedImages.length) * 100;
                    progressBar.style.width = `${progress}%`;
                    uploadStatus.textContent = `이미지 분류 중... (${processedCount}/${selectedImages.length})`;
                    
                } catch (error) {
                    console.error(`이미지 처리 오류: ${error.message}`, imageFile);
                    processedCount++;
                }
            }
            
            // 분류 완료
            uploadStatus.textContent = `${selectedImages.length}개의 이미지 분류 완료!`;
            classifyBtn.disabled = false;
            saveBtnArea.style.display = 'block';
        });
        
        // CSV 파일로 결과 저장
        saveResultBtn.addEventListener('click', function() {
            // CSV 헤더 생성
            let csvContent = "파일명,분류 결과,신뢰도";
            
            // 모든 클래스에 대한 예측값 추가
            for (const label of labels) {
                csvContent += `,${label}`;
            }
            csvContent += "\n";
            
            // 모든 분류된 이미지에 대한 결과 추가
            for (const category in classifiedImages) {
                for (const item of classifiedImages[category]) {
                    let row = `"${item.file.name}","${category}",${item.confidence.toFixed(4)}`;
                    
                    // 각 클래스에 대한 확률 추가
                    for (const prediction of item.predictions) {
                        row += `,${prediction.probability.toFixed(4)}`;
                    }
                    
                    csvContent += row + "\n";
                }
            }
            
            // CSV 파일 다운로드
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `탈모_분류_결과_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    </script>
</body>
</html>
